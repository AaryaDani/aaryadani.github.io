<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta charset="utf-8" />
    <script type="application/javascript" src="/js/main.js"></script>
    <link rel="icon" href="img/icon.jpg" />
    <title>Retro Bowl | 3kh0</title>

    <style>
      body {
        background: #000;
        color: #cccccc;
        margin: 0;
        padding: 0;
        border: 0;
      }
      canvas {
        image-rendering: optimizeSpeed;
        -webkit-interpolation-mode: nearest-neighbor;
        -ms-touch-action: none;
        margin: 0;
        padding: 0;
        border: 0;
      }
      :-webkit-full-screen #canvas {
        width: 100%;
        height: 100%;
      }
      div.gm4html5_div_class {
        margin: 0;
        padding: 0;
        border: 0;
      }
      :-webkit-full-screen {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>

  <body onload="check();">
    <div class="gm4html5_div_class" id="gm4html5_div_id">
      <img
        src="html5game/splash.png"
        id="GM4HTML5_loadingscreen"
        alt="GameMaker:HTML5 loading screen"
        style="display: none;"
      />
      <canvas id="canvas" width="853" height="480">
        <p>Your browser doesn't support HTML5 canvas.</p>
      </canvas>
    </div>

    <!-- Load the base game -->
    <script type="text/javascript" src="html5game/RetroBowl.js"></script>

    <!-- Load your custom roster expansion -->
    <script type="text/javascript" src="/js/roster_expand.js"></script>

    <!-- Add the OL stat tracking system -->
    <script>
      (function trackOLStats() {
        console.log("Tracking OL stats...");

        const waitForStats = () => {
          if (window.game && game.playResult) {
            const oldPlayResult = game.playResult;

            // Wrap play result logic
            game.playResult = function (...args) {
              const result = oldPlayResult.apply(this, args);

              // Add OL stat tracking logic
              if (game.team_offense) {
                game.team_offense
                  .filter((p) => p.pos === "OL")
                  .forEach((ol) => {
                    if (!ol.stats)
                      ol.stats = { plays: 0, blocks: 0, sacks_allowed: 0 };

                    ol.stats.plays++;

                    // Basic example: if QB is sacked, assign a "sack allowed"
                    if (result && result.type === "sack") {
                      ol.stats.sacks_allowed++;
                    } else {
                      ol.stats.blocks++;
                    }
                  });
              }

              return result;
            };

            console.log("✅ OL stat tracking enabled.");
          } else {
            setTimeout(waitForStats, 1000);
          }
        };

        waitForStats();
      })();
    </script>

    <!-- ⭐ Add the OL-based star display system -->
    <script>
      (function showStarsForOL() {
        console.log("⭐ Enabling OL-based star display...");

        const waitForGame = () => {
          if (!window.game) return setTimeout(waitForGame, 1000);

          // Continuously draw stars based on OL count
          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");

          function drawOLStars() {
            try {
              const olCount = game.roster
                ? game.roster.filter((p) => p.pos === "OL").length
                : 0;

              if (olCount > 0) {
                const starX = 690; // adjust horizontally near "OFFENSE"
                const starY = 460; // adjust vertically as needed
                const spacing = 18;

                // Draw one star per OL
                for (let i = 0; i < olCount; i++) {
                  ctx.fillStyle = "#ffd700";
                  ctx.beginPath();
                  ctx.moveTo(starX + i * spacing, starY);
                  ctx.lineTo(starX + 6 + i * spacing, starY + 10);
                  ctx.lineTo(starX - 6 + i * spacing, starY + 10);
                  ctx.closePath();
                  ctx.fill();
                }
              }
            } catch (e) {}

            requestAnimationFrame(drawOLStars);
          }

          drawOLStars();
        };

        waitForGame();
      })();
    </script>

    <!-- Keep the Poki SDK setup -->
    <script>
      (function () {
        function fin(ok) {
          (function checkInit() {
            var _0x151adb = [
              "bG9jYWxob3N0",
              "LnBva2kuY29t",
              "LnBva2ktZ2RuLmNvbQ==",
            ];
            var _0x219654 = true;
            var _0x558823 = window.location.hostname;
            for (
              var _0x220888 = 0x0;
              _0x220888 < _0x151adb.length;
              _0x220888++
            ) {
              var _0x4a2f49 = atob(_0x151adb[_0x220888]);
              if (
                _0x558823.indexOf(
                  _0x4a2f49,
                  _0x558823.length - _0x4a2f49.length
                ) !== -0x1
              ) {
                _0x219654 = true;
                break;
              }
            }
            if (!_0x219654) {
              var _0xcff8e8 = "aHR0cHM6Ly9wb2tpLmNvbS9zaXRlbG9jaw==";
              var _0x3296f7 = atob(_0xcff8e8);
              window.location.href = _0x3296f7;
              this.top.location !== this.location &&
                (this.top.location = this.location);
            }
          })();
          window.PokiSDK_OK = ok;
          GameMaker_Init();
        }
        window.addEventListener("load", function (_) {
          window.PokiSDK_loadState = 0;
          if (window.PokiSDK) {
            PokiSDK.init()
              .then(function () {
                fin(true);
              })
              .catch(function () {
                fin(false);
              });
          } else {
            window.PokiSDK = null;
            fin(false);
          }
        });
      })();
    </script>
  </body>
</html>